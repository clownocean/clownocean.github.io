{"title":"Redis","date":"2022-12-03T14:43:54.000Z","date_formatted":{"ll":"Dec 3, 2022","L":"12/03/2022","MM-DD":"12-03"},"link":"2022/12/03/Storage/Redis","updated":"2022-12-04T14:01:51.541Z","content":"<h1 id=\"介绍\">介绍<a title=\"#介绍\" href=\"#介绍\"></a></h1>\n<h2 id=\"特点\">特点<a title=\"#特点\" href=\"#特点\"></a></h2>\n<ul>\n<li>\n<p>高性能</p>\n<p>底层C语言编写，内存数据库，通讯采用epoll非阻塞I/O多路复用机制</p>\n</li>\n<li>\n<p>线程安全</p>\n<p>单线程</p>\n</li>\n<li>\n<p>功能丰富</p>\n<p>数据结构、持久化、主从模式、哨兵模式、集群模式、模块化</p>\n</li>\n<li>\n<p>应用场景</p>\n<p>缓存、分布式锁、队列、集合、GEO、BitMap</p>\n</li>\n</ul>\n<h2 id=\"原理\">原理<a title=\"#原理\" href=\"#原理\"></a></h2>\n<ul>\n<li>内存数据库，读取速度快</li>\n<li>非阻塞IO，IO多路复用减少线程上下文切换和竞争</li>\n<li>单线程模型，保证每个操作原子性</li>\n<li>存储结构多样化，不同存储结构对数据存储进行了优化加快读取速度</li>\n<li>自己实现事件分离器，效率高，内部采用非阻塞执行方式，吞吐能力比较大</li>\n</ul>\n<h2 id=\"单进程单线程\">单进程单线程<a title=\"#单进程单线程\" href=\"#单进程单线程\"></a></h2>\n<p>优势</p>\n<ul>\n<li>代码清晰处理逻辑简单</li>\n<li>不用考虑锁问题，不存在加锁释放锁，不会出现死锁而导致性能消耗</li>\n<li>不存在多进程或多线程导致切换而消耗CPU</li>\n</ul>\n<p>弊端</p>\n<ul>\n<li>无法发挥多核CPU性能，不过可以通过单机开多个Redis实例来完善</li>\n</ul>\n<h1 id=\"安装\">安装<a title=\"#安装\" href=\"#安装\"></a></h1>\n<h2 id=\"源码编译安装\"><a href=\"https://redis.io/docs/getting-started/installation/install-redis-from-source/\">源码编译安装</a><a title=\"#源码编译安装\" href=\"#源码编译安装\"></a></h2>\n<h3 id=\"下载解压\">下载解压<a title=\"#下载解压\" href=\"#下载解压\"></a></h3>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://download.redis.io/redis-stable.tar.gz</span><br><span class=\"line\">tar -xzvf redis-stable.tar.gz</span><br></pre></td></tr></table></figure>\n<h3 id=\"依赖安装\">依赖安装<a title=\"#依赖安装\" href=\"#依赖安装\"></a></h3>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y gcc-c++ autoconf automake</span><br></pre></td></tr></table></figure>\n<p>编译Redis6需要升级gcc版本，默认yum安装的gcc版本是4.8.5</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">安装scl源</span></span><br><span class=\"line\">yum install -y centos-release-scl scl-utils-build</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">安装9版本的gcc、gcc-c++、gdb工具链</span></span><br><span class=\"line\">yum install -y devtoolset-9-toolchain</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">临时覆盖系统原有gcc引用</span></span><br><span class=\"line\">scl enable devtoolset-9 bash</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">查看gcc版本</span></span><br><span class=\"line\">gcc -v</span><br></pre></td></tr></table></figure>\n<h3 id=\"预编译\">预编译<a title=\"#预编译\" href=\"#预编译\"></a></h3>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd redis-stable</span><br><span class=\"line\">make</span><br></pre></td></tr></table></figure>\n<h3 id=\"安装-1\">安装<a title=\"#安装-1\" href=\"#安装-1\"></a></h3>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -p /usr/local/redis</span><br><span class=\"line\">make PREFIX=/usr/local/redis install</span><br></pre></td></tr></table></figure>\n<h3 id=\"启动方式\">启动方式<a title=\"#启动方式\" href=\"#启动方式\"></a></h3>\n<ul>\n<li>守护进程启动</li>\n</ul>\n<p>修改配置redis.conf</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">daemonize</span> <span class=\"string\">yes</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>配置开机启动</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">系统服务目录中创建文件</span></span><br><span class=\"line\">vi /etc/systemd/system/redis/service</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">[Unit]</span></span><br><span class=\"line\"><span class=\"attr\">Description</span>=<span class=\"string\">redis-server</span></span><br><span class=\"line\"><span class=\"attr\">After</span>=<span class=\"string\">network.target</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">[Service]</span></span><br><span class=\"line\"><span class=\"attr\">Type</span>=<span class=\"string\">forking</span></span><br><span class=\"line\"><span class=\"attr\">ExecStart</span>=<span class=\"string\">/usr/local/redis/bin/redis-server /usr/local/redis/bin/redis.conf</span></span><br><span class=\"line\"><span class=\"attr\">PrivateTmp</span>=<span class=\"string\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">[Install]</span></span><br><span class=\"line\"><span class=\"attr\">WantedBy</span>=<span class=\"string\">multi-usr.target</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"重载系统服务\">重载系统服务<a title=\"#重载系统服务\" href=\"#重载系统服务\"></a></h3>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br></pre></td></tr></table></figure>\n<h3 id=\"开机自启\">开机自启<a title=\"#开机自启\" href=\"#开机自启\"></a></h3>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl enable redis.service</span><br></pre></td></tr></table></figure>\n<h2 id=\"docker安装\">Docker安装<a title=\"#docker安装\" href=\"#docker安装\"></a></h2>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -d -p 6379:6379 --name redis redis:6.2 redis-server --requirepass xxx</span><br></pre></td></tr></table></figure>\n<p>启动命令说明：</p>\n<p>–appendonly yes：启用持久化存储</p>\n<p>–requirepass：设置redis密码</p>\n<h1 id=\"配置文件\">配置文件<a title=\"#配置文件\" href=\"#配置文件\"></a></h1>\n<ul>\n<li>daemonize 默认情况下，redis不是在后台运行的，如需要在后台运行，把该项值改为yes</li>\n<li>bind 指定redis只接收来自该ip地址的请求</li>\n<li>port 监听端口，默认6379</li>\n<li>databases 设置数据库的个数，默认使用数据库0</li>\n<li>save 设置redis进行数据库镜像的频率</li>\n<li>dbfilename 镜像备份文件的文件名</li>\n<li>dir 数据库镜像备份文件放置的路径</li>\n<li>requirepass 客户端连接后使用的密码</li>\n<li>maxclients 限制同时连接的客户数量</li>\n<li>maxmemory 设置redis能够使用的最大内存</li>\n</ul>\n<h1 id=\"数据类型\">数据类型<a title=\"#数据类型\" href=\"#数据类型\"></a></h1>\n<h2 id=\"字符串-strings\">字符串 strings<a title=\"#字符串-strings\" href=\"#字符串-strings\"></a></h2>\n<p>存储的值可以是<strong>字符串</strong>、<strong>整数</strong>或者<strong>浮点数</strong>，对整个字符串或者字符串其中一部分执行操作；对整数或者浮点数执行自增或者自减。</p>\n<p>一个由字符串组成的序列，采用预分配冗余空间的方式来减少内存的频繁分配，内部为当前字符串实际分配的空间capacity一般要高于实际字符串长度len。当字符串长度小于1M时，扩容都是加倍现有的空间，如果超过1M，扩容时一次只会多扩1M空间。<strong>注意字符串最大长度为512M</strong>。</p>\n<p><strong>应用场景</strong></p>\n<p>缓存数据提高查询性能。比如存储登录用户信息、商品信息、计数器(什么时候封锁一个IP地址、访问超过几次)等等</p>\n<h2 id=\"散列-hashs\">散列 hashs<a title=\"#散列-hashs\" href=\"#散列-hashs\"></a></h2>\n<p>类似Java中的HashMap，不同的是rehash方式不一样。rehash是耗时的操作，HashMap在字典很大时需要一次性全部rehash；redis为了高性能不阻塞服务采用渐进式rehash，在rehash同时保留新旧两个hash结构，查询时同时查询两个hash结构，然后在后续的定时任务以及hash操作指令中，逐渐将旧hash内容一点点迁移到新的hash结构中，当迁移完成就会使用新的hash结构取而代之；当hash移除最后一个元素之后，该结构会被自动删除，内存被回收。</p>\n<p><strong>应用场景</strong></p>\n<p>对象存储，与字符串不同，字符串需要将对象进行序列化之后才能保存，而hash可以将对象每个字段单独存储，这样可以节省序列化和反序列化的时间。如：用户购买记录，key为用户id，field为商品id，value为商品数量；购物车数据存储，key为用户id，field为商品id，value为购买数量。</p>\n<h2 id=\"列表-lists\">列表 lists<a title=\"#列表-lists\" href=\"#列表-lists\"></a></h2>\n<p>类似Java中的LinkedList，双向链表支持反向查找和遍历。插入和删除操作非常快，时间复杂度为O(1)，但是索引定位很慢，时间复杂度为O(n)。</p>\n<p><strong>应用场景</strong></p>\n<p>热销榜；工作队列(利用push操作，将任务存入lists中，然后工作线程用pop操作取出任务执行)；最新评论</p>\n<h2 id=\"集合-sets\">集合 sets<a title=\"#集合-sets\" href=\"#集合-sets\"></a></h2>\n<p>类似Java中的HashSet，内部实现时一个value永远为null的HashMap，通过计算hash的方式快速去重。使用哈希表构造，复杂度为O(1)，支持集合内的增删改查，多个集合间的交集、并集、差集操作。</p>\n<p><strong>应用场景</strong></p>\n<p>计算网站独立IP；用户画像中的用户标签；共同好友</p>\n<h2 id=\"有序集合-sorted-sets\">有序集合 sorted sets<a title=\"#有序集合-sorted-sets\" href=\"#有序集合-sorted-sets\"></a></h2>\n<p>保证内部value唯一性，给每个value赋予一个score，代表这个value的排序权重。内部使用HashMap和跳跃表skiplist来保证数据的存储和有序，HashMap存放成员到score的映射，跳跃表存放所有的成员，排序依据HashMap中的score。使用跳跃表结构可以获取较高的查询效率。sorted sets中最后一个value被移除后，数据结构会自动删除，内存被回收。</p>\n<p><strong>应用场景</strong></p>\n<p>游戏积分排行榜；优先级的任务列表；学生成绩表</p>\n","next":{"title":"Elasticsearch","link":"2022/11/16/Storage/Elasticsearch"},"plink":"http://example.com/2022/12/03/Storage/Redis/","toc":[{"id":"介绍","title":"介绍","index":"1","children":[{"id":"特点","title":"特点","index":"1.1"},{"id":"原理","title":"原理","index":"1.2"},{"id":"单进程单线程","title":"单进程单线程","index":"1.3"}]},{"id":"安装","title":"安装","index":"2","children":[{"id":"源码编译安装","title":"源码编译安装","index":"2.1","children":[{"id":"下载解压","title":"下载解压","index":"2.1.1"},{"id":"依赖安装","title":"依赖安装","index":"2.1.2"},{"id":"预编译","title":"预编译","index":"2.1.3"},{"id":"安装-1","title":"安装","index":"2.1.4"},{"id":"启动方式","title":"启动方式","index":"2.1.5"},{"id":"重载系统服务","title":"重载系统服务","index":"2.1.6"},{"id":"开机自启","title":"开机自启","index":"2.1.7"}]},{"id":"docker安装","title":"Docker安装","index":"2.2"}]},{"id":"配置文件","title":"配置文件","index":"3"},{"id":"数据类型","title":"数据类型","index":"4","children":[{"id":"字符串-strings","title":"字符串 strings","index":"4.1"},{"id":"散列-hashs","title":"散列 hashs","index":"4.2"},{"id":"列表-lists","title":"列表 lists","index":"4.3"},{"id":"集合-sets","title":"集合 sets","index":"4.4"},{"id":"有序集合-sorted-sets","title":"有序集合 sorted sets","index":"4.5"}]}],"reading_time":"1572 words in 10 min"}